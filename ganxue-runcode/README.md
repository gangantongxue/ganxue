# 敢学 RunCode - 代码执行服务

## 概述

敢学 RunCode 是敢学（GanXue）交互式学习平台的核心组件之一，负责安全地执行用户提交的代码并返回执行结果。该服务支持 Go、C 和 C++ 三种编程语言，通过 Redis 与平台其他组件通信，提供稳定、安全的代码执行环境。

## 功能特性

- **多语言支持**：支持 Go、C 和 C++ 三种编程语言的代码执行
- **实时反馈**：通过 Redis 消息队列实现异步代码执行和结果返回
- **安全隔离**：使用进程组管理和超时控制确保代码执行安全
- **错误处理**：捕获并返回编译错误、运行时错误和超时等异常情况
- **输入支持**：支持向执行的程序提供标准输入数据

## 技术栈

- **编程语言**：Go
- **通信中间件**：Redis
- **系统调用**：使用 syscall 包进行进程管理
- **容器化**：通过 Docker 进行隔离部署

## 工作原理

1. **代码获取**：服务从 Redis 队列中获取待执行的代码任务
2. **代码写入**：将用户代码写入对应的语言目录下的主文件
3. **编译执行**：
   - 编译阶段：将用户代码编译成可执行文件
   - 执行阶段：运行编译后的程序并捕获输出
4. **结果返回**：将执行结果（包括状态码和输出内容）序列化为 JSON 并写入 Redis
5. **超时控制**：为每个代码执行任务设置超时时间，防止恶意代码无限执行

## 核心流程

1. 服务启动时初始化 Redis 连接
2. 分别启动 Go、C 和 C++ 三种语言的代码执行协程
3. 每个协程通过 BLPop 命令从对应队列中获取任务
4. 执行代码并将结果通过 RPush 命令返回给调用者
5. 设置结果的过期时间（15分钟）以避免内存泄漏

## 目录结构

```
ganxue-runcode/
├── c/                 # C语言相关文件
│   └── main.c         # C代码执行模板
├── cpp/               # C++语言相关文件
│   └── main.cpp       # C++代码执行模板
├── go/                # Go语言相关文件
│   └── main.go        # Go代码执行模板
├── config.go          # 配置文件
├── main.go            # 主程序入口
├── Dockerfile         # Docker构建文件
└── wait_for_services.sh  # 服务启动依赖检查脚本
```

## 安全机制

- **超时控制**：每个代码执行任务最多执行10秒
- **进程组管理**：使用 `Setpgid: true` 确保子进程可以被正确终止
- **资源隔离**：通过 Docker 容器提供额外的隔离层
- **错误处理**：完善的错误捕获和报告机制，避免服务崩溃

## 配置说明

主要配置在 `config.go` 文件中，包括：

- Redis 服务器地址和端口：默认 "redis:6379"
- Redis 密码：从环境变量 `REDIS_PASSWORD` 获取
- Redis 数据库编号：默认 0

## 与其他组件的关系

- **ganxue-server**：提交代码执行任务并获取结果
- **Redis**：作为消息中间件，传递代码执行请求和结果

## 部署说明

该组件通常作为 Docker Compose 环境的一部分进行部署，与其他组件协同工作。详细部署步骤请参考根目录的 [README.md](../README.md)。

## 开发指南

### 本地开发环境设置

1. 确保已安装 Go 开发环境
2. 安装并启动 Redis 服务
3. 设置 `REDIS_PASSWORD` 环境变量
4. 运行 `go run main.go` 启动服务

### 注意事项

- 开发过程中需特别注意安全问题，避免代码执行环境被滥用
- 修改代码执行超时时间时需谨慎，过长可能导致资源浪费，过短可能影响正常代码执行
- 在生产环境中务必使用 Docker 进行部署，以提供额外的安全隔离

## 故障排查

常见问题及解决方法：

- **Redis 连接失败**：检查 Redis 服务是否正常运行，以及密码配置是否正确
- **代码执行超时**：检查用户代码是否存在死循环或长时间阻塞操作
- **编译失败**：检查用户代码是否存在语法错误或缺少必要的依赖

## 贡献指南

欢迎提交 Issue 和 Pull Request 来改进该组件。在提交代码前，请确保：

1. 代码通过编译且无警告
2. 新功能包含适当的错误处理和安全检查
3. 遵循项目现有的代码风格和架构

## 许可证

[MIT License](../LICENSE)